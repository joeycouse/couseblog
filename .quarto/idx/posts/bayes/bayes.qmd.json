{"title":"Modeling Naturally Occuring Hierarchies with Bayes","markdown":{"yaml":{"title":"Modeling Naturally Occuring Hierarchies with Bayes","author":"Joey Couse","date":"2022-09-01","description":"When a simple t-Test won't do - think bayesian","draft":true,"image":"bayes.png","categories":["demo","bayesian"],"execute":{"message":false,"echo":true,"warning":false}},"headingText":"What is a Hierarchical Model?","containsRefs":false,"markdown":"\n\n\n```{r}\n#| include: false\n\nlibrary(tidyverse)\nlibrary(brms)\nlibrary(gt)\n\n```\n\n![](bayes.png)\n\n\nHierarchies are pervasive in the natural work and modeling these relationship can yield rich and powerful analysis. \n\nMost students aren't exposed to the ideas of hierarchical modeling in traditional statistics curriculum. Bayesian hierarchical modeling helps illuminate complex relationships simultaneously without the pitfalls of multiple comparison testing from frequentist methods [^1].\n\n[^1]: If you aren't familiar with the pitfalls of multiple comparison testing suggest you read [Multiple Comparisons Problem](https://en.wikipedia.org/wiki/Multiple_comparisons_problem)\n\nHierarchy is everywhere:\n\n$$\nhousehold \\rightarrow neighborhood \\rightarrow town/city \\rightarrow county \\rightarrow state\n$$\n\n$$\nplayer \\rightarrow team \\rightarrow division \\rightarrow conference \\rightarrow league\n$$\n\n$$\nstudent \\rightarrow class \\rightarrow school \\rightarrow district\n$$\nHierarchical models account for chained dependencies within our data, and as a result more appropriately represent our intuitive understanding of these relationships. These dependencies are represented with group-level parameters e.g. a group intercept, and inform lower level parameter estimates. \n\nWhen we account for hierarchy in our statistical modeling we can answer comprehensive questions about our data without the need for multiple tests. We can directly model all relationships simultaneously and utilize all the available data without aggregation. \n\nHierarchical models aren't exclusive to Bayesian statistics [^2], though I think Bayesian models provide much richer and intuitive interpretations of model parameters (can someone explain a confidence interval again?).\n\n[^2]: To learn more about the frequentist version of hierarchical models [Random Effects model](https://en.wikipedia.org/wiki/Random_effects_model)\n\n## How to do Hierachical Modeling with R \n\nI'll demonstrate the benefits of hierarchical modeling using a data set of baseball player's batting average from the 2022 season publicly available [here](https://www.baseball-reference.com/leagues/majors/2021-standard-batting.shtml). I'll be using a suite of packages known as the [tidyverse](https://www.tidyverse.org/) from the R language.\n\n\nFirst I'll begin by reading in the dataset using the `read_csv` function.\n```{r}\n\ndf_raw <-\n  read_csv(\"baseball_stats_2021.csv\", name_repair = janitor::make_clean_names) |> \n  select(name,\n         team = tm,\n         at_bats = ab,\n         hits = h,\n         position = pos_summary,\n         name_additional\n         )\n\ndf_raw |> \n  head(10) |> \n  gt() |> \n  cols_label(name = md(\"**Name**\"),\n             team = md(\"**Team**\"),\n             at_bats = md(\"**At Bats**\"),\n             hits = md(\"**Hits**\"),\n             position = md(\"**Position**\"),\n             name_additional = md(\"**Name Id**\"))\n\n```\n\nWe have several players with zero at bats, and low sample sizes won't provide adequate precision especially since batting averages are typically \\< 0.5. I'm going to arbitrarily filter to include only players with at least 20 at bats for this reason. (Some more in depth analysis could be done to address this issue but is beyond the scope of this blog post).\n\n- The \"/\" symbol is used to denote when a player has played less than 10 games that that position, so I'm going to remove these from the position column. \n\n- There is \"D\" or \"H\" designation for a designated hitter and pinch-hitters, and since I'm not a baseball expert I'm going to strip those from the positions.\n\n- If a player plays multiple positions they have multiple numbers associated with their position e.g. (54, 5 means third baseman; 4 means second baseman). I'm pretty sure they are in listed in the number of games played at that position so I'm going to simplify and only use their most common position. \n\n```{r}\n# Create look-up table of position numbers to position name\nposition_numbers <- \n  tribble(~position_number, ~position_name,\n          1, \"pitcher\",\n          2, \"catcher\",\n          3, \"first_baseman\",\n          4, \"second_baseman\",\n          5, \"third_baseman\",\n          6, \"shortstop\",\n          7, \"left_fielder\",\n          8, \"center_fielder\",\n          9, \"right_fielder\")\n\ndf_clean <- \n  df_raw |> \n  mutate(position = str_remove(position, regex(\"(?=\\\\/).*\")),\n         position = str_remove(position, regex(\"[^a-zA-Z0-9]\")),\n         position = str_remove_all(position, regex(\"[HD]\")),\n         position = str_sub(position, 1,1 ),\n         position = as.numeric(position))|> \n  filter(!is.na(position),\n         position != 0,\n         at_bats >= 20)|> \n  left_join(position_numbers, by = c(\"position\" = \"position_number\")) |> \n  select(-position)\n\nhead(df_clean, 10) |> \n  gt() |> \n  cols_label(name = md(\"**Name**\"),\n             team = md(\"**Team**\"),\n             at_bats = md(\"**At Bats**\"),\n             hits = md(\"**Hits**\"),\n             position_name = md(\"**Position**\"),\n             name_additional = md(\"**Name Id**\"))\n\n```\n\nThis is looking good! Though, there is the case when a player plays for multiple teams in one season so we'll aggregate based on based on the player - position pair. \n\n```{r}\n\nat_bats <- \n  df_clean |> \n  group_by(name, name_additional, position_name) |> \n  summarise(at_bats = sum(at_bats),\n            hits = sum(hits)) |> \n  mutate(name = str_remove_all(name, \"[^a-zA-z\\\\s]\")) |> \n  ungroup() \n\nat_bats |> \n  slice_head(n = 10) |> \n  gt() |> \n  cols_label(name = md(\"**Name**\"),\n             name_additional = md(\"**Name Id**\"),\n             position_name = md(\"**Position**\"),\n             at_bats = md(\"**At Bats**\"),\n             hits = md(\"**Hits**\")\n             )\n\n```\n\nGreat, after aggregating we have our data formatted appropriately for a binomial model.\n\nTo give some intuition on how hierarchical models work, ","srcMarkdownNoYaml":"\n\n\n```{r}\n#| include: false\n\nlibrary(tidyverse)\nlibrary(brms)\nlibrary(gt)\n\n```\n\n![](bayes.png)\n\n## What is a Hierarchical Model?\n\nHierarchies are pervasive in the natural work and modeling these relationship can yield rich and powerful analysis. \n\nMost students aren't exposed to the ideas of hierarchical modeling in traditional statistics curriculum. Bayesian hierarchical modeling helps illuminate complex relationships simultaneously without the pitfalls of multiple comparison testing from frequentist methods [^1].\n\n[^1]: If you aren't familiar with the pitfalls of multiple comparison testing suggest you read [Multiple Comparisons Problem](https://en.wikipedia.org/wiki/Multiple_comparisons_problem)\n\nHierarchy is everywhere:\n\n$$\nhousehold \\rightarrow neighborhood \\rightarrow town/city \\rightarrow county \\rightarrow state\n$$\n\n$$\nplayer \\rightarrow team \\rightarrow division \\rightarrow conference \\rightarrow league\n$$\n\n$$\nstudent \\rightarrow class \\rightarrow school \\rightarrow district\n$$\nHierarchical models account for chained dependencies within our data, and as a result more appropriately represent our intuitive understanding of these relationships. These dependencies are represented with group-level parameters e.g. a group intercept, and inform lower level parameter estimates. \n\nWhen we account for hierarchy in our statistical modeling we can answer comprehensive questions about our data without the need for multiple tests. We can directly model all relationships simultaneously and utilize all the available data without aggregation. \n\nHierarchical models aren't exclusive to Bayesian statistics [^2], though I think Bayesian models provide much richer and intuitive interpretations of model parameters (can someone explain a confidence interval again?).\n\n[^2]: To learn more about the frequentist version of hierarchical models [Random Effects model](https://en.wikipedia.org/wiki/Random_effects_model)\n\n## How to do Hierachical Modeling with R \n\nI'll demonstrate the benefits of hierarchical modeling using a data set of baseball player's batting average from the 2022 season publicly available [here](https://www.baseball-reference.com/leagues/majors/2021-standard-batting.shtml). I'll be using a suite of packages known as the [tidyverse](https://www.tidyverse.org/) from the R language.\n\n\nFirst I'll begin by reading in the dataset using the `read_csv` function.\n```{r}\n\ndf_raw <-\n  read_csv(\"baseball_stats_2021.csv\", name_repair = janitor::make_clean_names) |> \n  select(name,\n         team = tm,\n         at_bats = ab,\n         hits = h,\n         position = pos_summary,\n         name_additional\n         )\n\ndf_raw |> \n  head(10) |> \n  gt() |> \n  cols_label(name = md(\"**Name**\"),\n             team = md(\"**Team**\"),\n             at_bats = md(\"**At Bats**\"),\n             hits = md(\"**Hits**\"),\n             position = md(\"**Position**\"),\n             name_additional = md(\"**Name Id**\"))\n\n```\n\nWe have several players with zero at bats, and low sample sizes won't provide adequate precision especially since batting averages are typically \\< 0.5. I'm going to arbitrarily filter to include only players with at least 20 at bats for this reason. (Some more in depth analysis could be done to address this issue but is beyond the scope of this blog post).\n\n- The \"/\" symbol is used to denote when a player has played less than 10 games that that position, so I'm going to remove these from the position column. \n\n- There is \"D\" or \"H\" designation for a designated hitter and pinch-hitters, and since I'm not a baseball expert I'm going to strip those from the positions.\n\n- If a player plays multiple positions they have multiple numbers associated with their position e.g. (54, 5 means third baseman; 4 means second baseman). I'm pretty sure they are in listed in the number of games played at that position so I'm going to simplify and only use their most common position. \n\n```{r}\n# Create look-up table of position numbers to position name\nposition_numbers <- \n  tribble(~position_number, ~position_name,\n          1, \"pitcher\",\n          2, \"catcher\",\n          3, \"first_baseman\",\n          4, \"second_baseman\",\n          5, \"third_baseman\",\n          6, \"shortstop\",\n          7, \"left_fielder\",\n          8, \"center_fielder\",\n          9, \"right_fielder\")\n\ndf_clean <- \n  df_raw |> \n  mutate(position = str_remove(position, regex(\"(?=\\\\/).*\")),\n         position = str_remove(position, regex(\"[^a-zA-Z0-9]\")),\n         position = str_remove_all(position, regex(\"[HD]\")),\n         position = str_sub(position, 1,1 ),\n         position = as.numeric(position))|> \n  filter(!is.na(position),\n         position != 0,\n         at_bats >= 20)|> \n  left_join(position_numbers, by = c(\"position\" = \"position_number\")) |> \n  select(-position)\n\nhead(df_clean, 10) |> \n  gt() |> \n  cols_label(name = md(\"**Name**\"),\n             team = md(\"**Team**\"),\n             at_bats = md(\"**At Bats**\"),\n             hits = md(\"**Hits**\"),\n             position_name = md(\"**Position**\"),\n             name_additional = md(\"**Name Id**\"))\n\n```\n\nThis is looking good! Though, there is the case when a player plays for multiple teams in one season so we'll aggregate based on based on the player - position pair. \n\n```{r}\n\nat_bats <- \n  df_clean |> \n  group_by(name, name_additional, position_name) |> \n  summarise(at_bats = sum(at_bats),\n            hits = sum(hits)) |> \n  mutate(name = str_remove_all(name, \"[^a-zA-z\\\\s]\")) |> \n  ungroup() \n\nat_bats |> \n  slice_head(n = 10) |> \n  gt() |> \n  cols_label(name = md(\"**Name**\"),\n             name_additional = md(\"**Name Id**\"),\n             position_name = md(\"**Position**\"),\n             at_bats = md(\"**At Bats**\"),\n             hits = md(\"**Hits**\")\n             )\n\n```\n\nGreat, after aggregating we have our data formatted appropriately for a binomial model.\n\nTo give some intuition on how hierarchical models work, "},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":true,"echo":true,"output":true,"warning":false,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"ipynb-shell-interactivity":null,"plotly-connected":true,"message":false,"engine":"knitr"},"render":{"keep-tex":false,"keep-typ":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-min-runs":1,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[],"notebook-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","output-file":"bayes.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","other-links-title":"Other Links","code-links-title":"Code Links","launch-dev-container-title":"Launch Dev Container","launch-binder-title":"Launch Binder","article-notebook-label":"Article Notebook","notebook-preview-download":"Download Notebook","notebook-preview-download-src":"Download Source","notebook-preview-back":"Back to Article","manuscript-meca-bundle":"MECA Bundle","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","title-block-keywords":"Keywords","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","tools-share":"Share","tools-download":"Download","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-text-placeholder":"","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-wordcount":"Word Count","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items","listing-page-words":"{0} words"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.4.549","theme":"../../theme.scss","title-block-banner":true,"title":"Modeling Naturally Occuring Hierarchies with Bayes","author":"Joey Couse","date":"2022-09-01","description":"When a simple t-Test won't do - think bayesian","draft":true,"image":"bayes.png","categories":["demo","bayesian"]},"extensions":{"book":{"multiFile":true}}}},"projectFormats":["html"]}